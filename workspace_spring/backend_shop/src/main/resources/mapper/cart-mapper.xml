<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!-- namespace에는 xml파일과 연결할 Mapper interface 파일명을 패키지를 포함하여 적어주세요 -->
<mapper namespace="com.green.backend_shop.cart.mapper.CartMapper">
    <resultMap id="cart" type="com.green.backend_shop.cart.dto.CartDTO">
        <id column="CART_NUM"        property="cartNum" />
        <result column="BOOK_NUM"    property="bookNum" />
        <result column="CART_CNT"    property="cartCnt" />
        <result column="MEM_ID"      property="memId" />
        <result column="TOTAL_PRICE" property="totalPrice" />
        <result column="CART_DATE"   property="cartDate" />
        <!-- 장바구니 테이블을 기준으로 상품이 1 : 1이다. 헷갈릴 수 있다. -->
        <!-- 연동할 resultMap이 다르면 다른파일에 있으면 다른 파일의 namespace와 id를 함께 추가한다. -->
        <!-- column에 title이 없으므로 resultMap을 참조한다(bookMapper의 resultMap을 참조). -->
        <!-- 참조했을 때 title이 있으므로 bookDTO에 title이 들어가서 조회될 때 bookDTO에 값이 채워져 나온다. -->
        <association property="bookDTO" resultMap="com.green.backend_shop.book.mapper.BookMapper.book" />
    </resultMap>

    <!-- 장바구니에 물품 등록 쿼리 -->
    <insert id="insertCart">
        INSERT INTO SHOP_CART (
            BOOK_NUM
            , CART_CNT
            , MEM_ID
            , TOTAL_PRICE
        ) VALUES (
            #{bookNum}
            , #{cartCnt}
            , #{memId}
            , (SELECT PRICE
                FROM BOOK
                WHERE BOOK_NUM = #{bookNum}
            ) * #{cartCnt}
        )
    </insert>

    <!-- 장바구니 목록 조회 쿼리 -->
    <select id="getCartList" resultMap="cart">
        SELECT CART_NUM
        , C.BOOK_NUM
        <!-- title이 조회될 때 cart resultMap 정의문을 본다. -->
        , TITLE
        , PRICE
        , CART_CNT
        , TOTAL_PRICE
        , CART_DATE
        FROM shop_cart C
        INNER JOIN book B
        ON B.BOOK_NUM = C.BOOK_NUM
        WHERE MEM_ID = #{memId}
        ORDER BY CART_DATE DESC;
    </select>

    <!-- 쿼리를 미리 써놓으면 어떤 데이터가 들어갈지 미리 파악할 수 있다. -->
    <!-- 장바구니에 등록하려는 상품이 현재 등록되어 있는지 확인 -->
    <select id="getCartNum" resultType="String">
        SELECT MEM_ID
        FROM SHOP_CART
        WHERE BOOK_NUM = #{bookNum}
        AND MEM_ID = #{memId}
    </select>

    <!-- 장바구니 수량 변경 -->
    <update id="updateCartCnt">
        UPDATE SHOP_CART
        SET CART_CNT = CART_CNT + #{cartCnt}
            , TOTAL_PRICE = (SELECT PRICE
                        FROM BOOK
                        WHERE BOOK_NUM = #{bookNum}) * CART_CNT
        WHERE BOOK_NUM = #{bookNum}
        AND MEM_ID = #{memId}
    </update>

</mapper>